#!/usr/bin/env python
"""
##########################################################################
# Module:
#   jobsub_probe_url
#
# Project:
#   JobSub
#
# Author:
#   Dennis Box
#
# Description:
#   This program sends a single url to a jobsub server and prints out
#   its response.  Useful for development and debugging
#
##########################################################################
"""
from __future__ import print_function
from __future__ import absolute_import
from __future__ import unicode_literals
from __future__ import division
from future import standard_library
standard_library.install_aliases()
import sys
import os
import argparse
import traceback
import logSupport
from jobsubClient import JobSubClient
from jobsubClient import JobSubClientError
from jobsubClient import Version_String
from jobsubClient import http_code_to_rc
from defaultServer import defaultServer


def print_opts(options):
    """
    print out options from optarg
    """
    logSupport.dprint('COMMAND LINE OPTIONS:')
    logSupport.dprint('%s' % options)




def parse_opts(argv):
    """ Set up argparse object and epilog message
    """
    usage = '%(prog)s [Client Options]'
    epi_text = "Please direct questions, comments, or problems to the "
    epi_text += "service desk. "
    epi_text += "For help on --jobid or --constraint see "
    epi_text += """https://cdcvs.fnal.gov/redmine/projects/jobsub/"""
    epi_text += """wiki/Frequently_Asked_Questions"""
    parser = argparse.ArgumentParser(usage=usage,
                                   conflict_handler="resolve",
                                   epilog=epi_text)

    client_options = parser.add_argument_group("Client Options")

    # Optional args
    client_options.add_argument('-G', '--group',
                         dest='acctGroup',
                         type=str,
                         action='store',
                         metavar='<Group/Experiment/Subgroup>',
                         default=os.environ.get('JOBSUB_GROUP'),
                         help="".join(['Group/Experiment/Subgroup ',
                                       'for priorities and accounting',
                                      ]))

    client_options.add_argument('--jobsub-server',
                         dest='jobsubServer',
                         action='store',
                         metavar='<JobSub Server>',
                         default=defaultServer(),
                         help='Alternate location of JobSub server to use')


    client_options.add_argument('--endpoint',
                         dest='endpoint',
                         action='store',
                         help='REST API ENDPOINT')

    client_options.add_argument('--post-data',
                         dest='post_data',
                         action='store',
                         default=None,
                         help='post_data')

    client_options.add_argument('--action',
                         dest='action',
                         action='store',
                         help='HTTP ACTION (GET, etc)')

    client_options.add_argument('-h', '--help',
                         dest='help',
                         action='store_true',
                         default=False,
                         help='Show this help message and exit')

    client_options.add_argument('--debug',
                         dest='debug',
                         action='store_true',
                         default=False,
                         help='debug')


    client_options.add_argument('--version',
                        action=Version_String)



    if len(argv) < 1:
        print("ERROR: Insufficient arguments specified")
        parser.print_help()
        sys.exit(1)

    options, remainder = parser.parse_known_args(argv)

    if options.help or (len(remainder) > 1):
        parser.print_help()
        sys.exit(0)

    return options


def main(argv):
    """
    the pain and gain stems mainly from this main()
    """
    options = parse_opts(argv)
    logSupport.init_logging(options.debug)
    logSupport.dprint('CLIENT_ARGS: ', vars(options))
    rcd = 1

    optDict = {'debug':options.debug,
               'action':options.action,
               'endpoint':options.endpoint
              }

    js_client = JobSubClient(options.jobsubServer,
                             options.acctGroup,
                             None,
                             [],
                             extra_opts=optDict)
    try:

        url = "%s/%s/" %(js_client.server, options.endpoint)
        post_data = None
        if options.post_data:
            post_data = eval(options.post_data)
        http_code = js_client.changeJobState(url,
                                             options.action,
                                             post_data, False)
        rcd = http_code_to_rc(http_code)
    except JobSubClientError as err:
        print(err)
        logSupport.dprint(traceback.format_exc())
    except Exception as err:
        print(err)
        logSupport.dprint('%s' % traceback.print_exc())

    return rcd


if __name__ == '__main__':
    sys.exit(main(sys.argv))
