import os
import sys
import time
import pytest

#
# we assume everwhere our current directory is in the package 
# test area, so go ahead and cd there
#
os.chdir(os.path.dirname(__file__))


#
# import modules we need to test, since we chdir()ed, can use relative path
#
sys.path.append("../lib")
import creds
import condor
from test_unit import TestUnit 
from test_creds_unit import needs_credentials


@pytest.fixture
def get_submit_file():
    filename="/tmp/tst{0}.sub".format(os.getpid())
    f = open(filename, "w")
    f.write("""
# generated by jobsub_lite 
# 
universe           = vanilla
executable         = /bin/true
arguments          = 

output             = lookaround.xx.$(Cluster).$(Process).out
error              = lookaround.xx.$(Cluster).$(Process).err
log                = lookaround.xx.$(Cluster).$(Process).log
environment        = CLUSTER=$(Cluster);PROCESS=$(Process);CONDOR_TMP=;BEARER_TOKEN_FILE=.condor_creds/{group}.use;CONDOR_EXEC=/tmp;DAGMANJOBID=$(DAGManJobId);GRID_USER={user};JOBSUBJOBID=$(CLUSTER).$(PROCESS)@jobsubdevgpvm01.fnal.gov;EXPERIMENT={group};SAM_EXPERIMENT=samdev
rank               = Mips / 2 + Memory
job_lease_duration = 3600
notification       = Never
transfer_output    = True
transfer_error     = True
transfer_executable= True
when_to_transfer_output = ON_EXIT_OR_EVICT
transfer_output_files = .empty_file
request_memory = 2048.0
request_disk = 102400.0KB
+JobsubClientDN=""
+JobsubClientIpAddress="131.225.67.71"
+Owner="{user}"
+JobsubServerVersion="lite_v1_0"
+JobsubClientVersion="lite_v1_0"
+JobsubClientKerberosPrincipal=""
+JOB_EXPECTED_MAX_LIFETIME = 28800.0
notify_user = {user}@fnal.gov
+AccountingGroup = "group_{group}.{user}"
+Jobsub_Group="{group}"
+JobsubJobId="$(CLUSTER).$(PROCESS)@jobsubdevgpvm01.fnal.gov"
+Drain = False
+GeneratedBy =" jobsubdevgpvm01.fnal.gov"

+DESIRED_usage_model="OPPORTUNISTIC,DEDICATED"

requirements  = target.machine =!= MachineAttrMachine1 && target.machine =!= MachineAttrMachine2  && (isUndefined(DesiredOS) || stringListsIntersect(toUpper(DesiredOS),IFOS_installed)) && (stringListsIntersect(toUpper(target.HAS_usage_model, toUpper(my.DESIRED_usage_model))))

#
# this is supposed to get us output even if jobs are held(?)
#
+SpoolOnEvict = false
#
#
#
use_oauth_services = {group}

queue 1
    """.format( user = os.environ["USER"], group = TestUnit.test_group ))
    f.close()
    return filename

@pytest.fixture
def get_dag_file(self):
    filename="/tmp/tst{0}.dag".format(os.getpid())
    f = open(filename, "w")
    f.write("""
    """)
    f.close()
    return filename

class TestCondorUnit:
    """
        Use with pytest... unit tests for ../lib/*.py
    """

    # lib/condor.py routines...

    def test_get_schedd_1(self):
        """  make sure we get our test schedd back with test_vargs """
        schedd =  condor.get_schedd(TestUnit.test_vargs)
        print("got schedd: {0}".format(schedd))
        print("schedd name: {0}".format(schedd['Name']))
        assert schedd['Name'] == TestUnit.test_schedd

    def test_load_submit_file_1(self, get_submit_file):
        """  make sure load_submit_file result has bits of the submit file"""
        res = condor.load_submit_file(get_submit_file)
        assert str(res[0]).find('universe = vanilla') >= 0
        assert str(res[0]).find('executable = /bin/true') >= 0

    def test_submit_1(self, get_submit_file, needs_credentials):
        """ actually submit a job with condor_submit """
        res = condor.submit(get_submit_file, TestUnit.test_vargs, TestUnit.test_schedd )
        print("got: " , res)
        assert res

    def x_test_submit_dag_1(self):
        """ actually submit a dag with condor_submit_dag """
        # XXX fix me
        res = condor.submit_dag(self.get_dag_file(), TestUnit.test_vargs, TestUnit.test_schedd, cmd_args=[])
        assert res
